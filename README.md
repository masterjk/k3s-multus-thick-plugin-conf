# k3s-multus-thick-plugin-conf

**Working configuration for K3s with Flannel** - This repository stores a tested and functional configuration for deploying Multus thick plugin on K3s clusters using Flannel as the primary CNI.

## Prerequisites

- K3s cluster (any recent version)
- kubectl configured to access the cluster
- Flannel already running as primary CNI (default K3s setup)

## Installation

```bash
kubectl apply -f multus-daemonset-thick.yml
```

## Uninstalling

```bash
kubectl delete -f multus-daemonset-thick.yml
```

Then manually clean up host-side resources on each node:

```bash
# Remove Multus runtime directories
sudo rm -rf /run/multus/
sudo rm -rf /var/lib/cni/multus/

# Remove ipvlan and host-local plugins (if you want clean removal)
sudo rm -f /var/lib/rancher/k3s/data/cni/ipvlan
sudo rm -f /var/lib/rancher/k3s/data/cni/multus-shim
sudo rm -f /var/lib/rancher/k3s/data/cni/passthru
sudo rm -f /var/lib/rancher/k3s/data/cni/host-local

# Restore host-local
sudo ln -s $(readlink /var/lib/rancher/k3s/data/cni/flannel) /var/lib/rancher/k3s/data/cni/host-local

# Remove Multus CNI config (should already be removed)
sudo rm -f /var/lib/rancher/k3s/agent/etc/cni/net.d/00-multus.conf
```

## Files Changed on Host Machine

After deploying the Multus thick plugin, the following changes occur on each K3s node:

### ğŸ“ CNI Plugins Directory

```
/var/lib/rancher/k3s/data/cni/
â”œâ”€â”€ ipvlan                    [NEW - from init container]
â”œâ”€â”€ host-local                [OVERWRITTEN - from init container]
â”œâ”€â”€ multus-shim               [NEW - from init container]
â”œâ”€â”€ passthru                  [NEW - from init container]
â”œâ”€â”€ bandwidth                 [existing symlink, unchanged]
â”œâ”€â”€ bridge                    [existing symlink, unchanged]
â”œâ”€â”€ cni                       [existing symlink, unchanged]
â”œâ”€â”€ firewall                  [existing symlink, unchanged]
â”œâ”€â”€ flannel                   [existing symlink, unchanged]
â”œâ”€â”€ loopback                  [existing symlink, unchanged]
â””â”€â”€ portmap                   [existing symlink, unchanged]
```

### ğŸ“ Multus Runtime Directories

```
/run/multus/                  [NEW - created by Multus daemon]
â”œâ”€â”€ multus-cni-network.sock   [NEW - Unix socket for Multus]
â””â”€â”€ (other runtime files)

/var/lib/cni/multus/          [NEW - created by Multus daemon]
â””â”€â”€ (pod network attachment metadata)
```

### ğŸ“ CNI Configuration Files

```
/var/lib/rancher/k3s/agent/etc/cni/net.d/
â”œâ”€â”€ 10-flannel.conflist       [EXISTING - Flannel config, unchanged]
â””â”€â”€ 00-multus.conf            [NEW - Generated by Multus daemon] (contains multus-shim CNI config)
```



## Testing

This repository includes test files to verify the secondary networking setup:

### Available Test Files

- **`test/net-attach-def-ipvlan.yaml`**: NetworkAttachmentDefinition for IPvlan secondary network (be sure to update the `NIC_NAME`)
- **`test/alpine.yaml`**: Simple test pod that attaches to the secondary network

### Quick Test

1. Deploy the NetworkAttachmentDefinition:

```bash
kubectl apply -f test/net-attach-def-ipvlan.yaml
```

2. Deploy a test pod with secondary network attachment:

```bash
kubectl apply -f test/alpine.yaml
```

3. Verify the pod has two network interfaces:

```bash
# Get pod details
kubectl get pod -o wide

# Check interfaces inside the pod
kubectl exec -it <pod-name> -- ip link show
```

Expected output should show:
- `eth0`: Primary network (Flannel)
- `net1`: Secondary network (IPvlan)


## References

- [Multus CNI GitHub Repository](https://github.com/k8snetworkplumbingwg/multus-cni)
- [Multus Thin Plugin vs Thick Plugin Comparison](https://github.com/k8snetworkplumbingwg/multus-cni?tab=readme-ov-file#thin-plugin-vs-thick-plugin)
- [K3s CNI Documentation](https://docs.k3s.io/networking)
- [NetworkAttachmentDefinition CRD](https://github.com/k8snetworkplumbingwg/multus-cni/blob/master/docs/how-to-use.md)

## Developer Notes

### Thick Plugin vs Thin Plugin

**Multus 4.0 introduced a new deployment model:** the thick plugin is now the recommended approach over the traditional thin plugin deployment.

| Feature              | Thick Plugin                                | Thin Plugin                              |
|----------------------|---------------------------------------------|------------------------------------------|
| **Deployment Model** | Client/server (multus-daemon + multus-shim) | Single binary                            |
| **Metrics Support**  | âœ“ Supported                                 | âœ— Not available                          |
| **Features**         | Additional features via daemon              | Basic functionality only                 |
| **Resource Usage**   | Higher                                      | Lower                                    |
| **Recommendation**   | âœ“ Recommended for most environments         | Legacy/resource-constrained environments |


For detailed comparison, see the [Multus CNI documentation](https://github.com/k8snetworkplumbingwg/multus-cni?tab=readme-ov-file#thin-plugin-vs-thick-plugin).
