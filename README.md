# k3s-multus-thick-plugin-conf

**Working configuration for K3s with Flannel** - This repository stores a tested and functional configuration for deploying Multus thick plugin on K3s clusters using Flannel as the primary CNI.

## References

- [Multus CNI GitHub Repository](https://github.com/k8snetworkplumbingwg/multus-cni)
- [Multus Thin Plugin vs Thick Plugin Comparison](https://github.com/k8snetworkplumbingwg/multus-cni?tab=readme-ov-file#thin-plugin-vs-thick-plugin)
- [K3s CNI Documentation](https://docs.k3s.io/networking)
- [NetworkAttachmentDefinition CRD](https://github.com/k8snetworkplumbingwg/multus-cni/blob/master/docs/how-to-use.md)

## Prerequisites

- K3s cluster (any recent version)
- kubectl configured to access the cluster
- Flannel already running as primary CNI (default K3s setup)

## Installation

```bash
kubectl apply -f multus-daemonset-thick.yml
```

## Uninstalling

```bash
kubectl delete -f multus-daemonset-thick.yml
```

Then manually clean up host-side resources on each node:

```bash
# Remove Multus runtime directories
sudo rm -rf /run/multus/
sudo rm -rf /var/lib/cni/multus/

# Remove ipvlan plugins (if you want clean removal)
sudo rm -f /var/lib/rancher/k3s/data/cni/ipvlan
sudo rm -f /var/lib/rancher/k3s/data/cni/multus-shim
sudo rm -f /var/lib/rancher/k3s/data/cni/passthru

# Remove Multus CNI config (should already be removed)
sudo rm -f /var/lib/rancher/k3s/agent/etc/cni/net.d/00-multus.conf
```

## Files Changed on Host Machine

After deploying the Multus thick plugin, the following changes occur on each K3s node:

### üìÅ CNI Plugins Directory

```
/var/lib/rancher/k3s/data/cni/
‚îú‚îÄ‚îÄ ipvlan                    [NEW - from init container]
‚îú‚îÄ‚îÄ multus-shim               [NEW - from init container]
‚îú‚îÄ‚îÄ passthru                  [NEW - from init container]
‚îú‚îÄ‚îÄ bandwidth                 [existing symlink, unchanged]
‚îú‚îÄ‚îÄ bridge                    [existing symlink, unchanged]
‚îú‚îÄ‚îÄ cni                       [existing symlink, unchanged]
‚îú‚îÄ‚îÄ firewall                  [existing symlink, unchanged]
‚îú‚îÄ‚îÄ flannel                   [existing symlink, unchanged]
‚îú‚îÄ‚îÄ host-local                [existing symlink, unchanged]
‚îú‚îÄ‚îÄ loopback                  [existing symlink, unchanged]
‚îî‚îÄ‚îÄ portmap                   [existing symlink, unchanged]
```

### üìÅ Multus Runtime Directories

```
/run/multus/                  [NEW - created by Multus daemon]
‚îú‚îÄ‚îÄ multus-cni-network.sock   [NEW - Unix socket for Multus]
‚îî‚îÄ‚îÄ (other runtime files)

/var/lib/cni/multus/          [NEW - created by Multus daemon]
‚îî‚îÄ‚îÄ (pod network attachment metadata)
```

### üìÅ CNI Configuration Files

```
/var/lib/rancher/k3s/agent/etc/cni/net.d/
‚îú‚îÄ‚îÄ 10-flannel.conflist       [EXISTING - Flannel config, unchanged]
‚îî‚îÄ‚îÄ 00-multus.conf            [NEW - Generated by Multus daemon] (contains multus-shim CNI config)
```



## Testing

This repository includes test files to verify the secondary networking setup:

### Available Test Files

- **`test/net-attach-def-ipvlan.yaml`**: NetworkAttachmentDefinition for IPvlan secondary network (be sure to update the `NIC_NAME`)
- **`test/alpine.yaml`**: Simple test pod that attaches to the secondary network

### Quick Test

1. Deploy the NetworkAttachmentDefinition:

```bash
kubectl apply -f test/net-attach-def-ipvlan.yaml
```

2. Deploy a test pod with secondary network attachment:

```bash
kubectl apply -f test/alpine.yaml
```

3. Verify the pod has two network interfaces:

```bash
# Get pod details
kubectl get pod -o wide

# Check interfaces inside the pod
kubectl exec -it <pod-name> -- ip link show
```

Expected output should show:
- `eth0`: Primary network (Flannel)
- `net1`: Secondary network (IPvlan)


## Metrics and Monitoring

The Multus thick plugin exposes Prometheus metrics on port `19090` at the `/metrics` endpoint. This enables monitoring of network attachment operations and performance. A Kubernetes `Service` and `ServiceMonitor` named `multus-http-metrics` are automatically created in the `kube-system` namespace to expose the metrics endpoint.

### Available Metrics

Multus thick plugin exposes the following application-specific metrics:

```
# HELP go_gc_duration_seconds A summary of the wall-time pause (stop-the-world) duration in garbage collection cycles.
# TYPE go_gc_duration_seconds summary
go_gc_duration_seconds{quantile="0"} 0.000107689
go_gc_duration_seconds{quantile="0.25"} 0.000120072
go_gc_duration_seconds{quantile="0.5"} 0.000129565
go_gc_duration_seconds{quantile="0.75"} 0.000133885
go_gc_duration_seconds{quantile="1"} 0.000148182
go_gc_duration_seconds_sum 0.004208486
go_gc_duration_seconds_count 33
# HELP go_gc_gogc_percent Heap size target percentage configured by the user, otherwise 100. This value is set by the GOGC environment variable, and the runtime/debug.SetGCPercent function. Sourced from /gc/gogc:percent.
# TYPE go_gc_gogc_percent gauge
go_gc_gogc_percent 100
# HELP go_gc_gomemlimit_bytes Go runtime memory limit configured by the user, otherwise math.MaxInt64. This value is set by the GOMEMLIMIT environment variable, and the runtime/debug.SetMemoryLimit function. Sourced from /gc/gomemlimit:bytes.
# TYPE go_gc_gomemlimit_bytes gauge
go_gc_gomemlimit_bytes 9.223372036854776e+18
# HELP go_goroutines Number of goroutines that currently exist.
# TYPE go_goroutines gauge
go_goroutines 38
# HELP go_info Information about the Go environment.
# TYPE go_info gauge
go_info{version="go1.24.11"} 1
# HELP go_memstats_alloc_bytes Number of bytes allocated in heap and currently in use. Equals to /memory/classes/heap/objects:bytes.
# TYPE go_memstats_alloc_bytes gauge
go_memstats_alloc_bytes 1.1950464e+07
# HELP go_memstats_alloc_bytes_total Total number of bytes allocated in heap until now, even if released already. Equals to /gc/heap/allocs:bytes.
# TYPE go_memstats_alloc_bytes_total counter
go_memstats_alloc_bytes_total 8.601812e+07
# HELP go_memstats_buck_hash_sys_bytes Number of bytes used by the profiling bucket hash table. Equals to /memory/classes/profiling/buckets:bytes.
# TYPE go_memstats_buck_hash_sys_bytes gauge
go_memstats_buck_hash_sys_bytes 5870
# HELP go_memstats_frees_total Total number of heap objects frees. Equals to /gc/heap/frees:objects + /gc/heap/tiny/allocs:objects.
# TYPE go_memstats_frees_total counter
go_memstats_frees_total 327878
# HELP go_memstats_gc_sys_bytes Number of bytes used for garbage collection system metadata. Equals to /memory/classes/metadata/other:bytes.
# TYPE go_memstats_gc_sys_bytes gauge
go_memstats_gc_sys_bytes 3.35864e+06
# HELP go_memstats_heap_alloc_bytes Number of heap bytes allocated and currently in use, same as go_memstats_alloc_bytes. Equals to /memory/classes/heap/objects:bytes.
# TYPE go_memstats_heap_alloc_bytes gauge
go_memstats_heap_alloc_bytes 1.1950464e+07
# HELP go_memstats_heap_idle_bytes Number of heap bytes waiting to be used. Equals to /memory/classes/heap/released:bytes + /memory/classes/heap/free:bytes.
# TYPE go_memstats_heap_idle_bytes gauge
go_memstats_heap_idle_bytes 1.478656e+07
# HELP go_memstats_heap_inuse_bytes Number of heap bytes that are in use. Equals to /memory/classes/heap/objects:bytes + /memory/classes/heap/unused:bytes
# TYPE go_memstats_heap_inuse_bytes gauge
go_memstats_heap_inuse_bytes 1.5458304e+07
# HELP go_memstats_heap_objects Number of currently allocated objects. Equals to /gc/heap/objects:objects.
# TYPE go_memstats_heap_objects gauge
go_memstats_heap_objects 29946
# HELP go_memstats_heap_released_bytes Number of heap bytes released to OS. Equals to /memory/classes/heap/released:bytes.
# TYPE go_memstats_heap_released_bytes gauge
go_memstats_heap_released_bytes 1.0125312e+07
# HELP go_memstats_heap_sys_bytes Number of heap bytes obtained from system. Equals to /memory/classes/heap/objects:bytes + /memory/classes/heap/unused:bytes + /memory/classes/heap/released:bytes + /memory/classes/heap/free:bytes.
# TYPE go_memstats_heap_sys_bytes gauge
go_memstats_heap_sys_bytes 3.0244864e+07
# HELP go_memstats_last_gc_time_seconds Number of seconds since 1970 of last garbage collection.
# TYPE go_memstats_last_gc_time_seconds gauge
go_memstats_last_gc_time_seconds 1.7678202083542306e+09
# HELP go_memstats_mallocs_total Total number of heap objects allocated, both live and gc-ed. Semantically a counter version for go_memstats_heap_objects gauge. Equals to /gc/heap/allocs:objects + /gc/heap/tiny/allocs:objects.
# TYPE go_memstats_mallocs_total counter
go_memstats_mallocs_total 357824
# HELP go_memstats_mcache_inuse_bytes Number of bytes in use by mcache structures. Equals to /memory/classes/metadata/mcache/inuse:bytes.
# TYPE go_memstats_mcache_inuse_bytes gauge
go_memstats_mcache_inuse_bytes 135296
# HELP go_memstats_mcache_sys_bytes Number of bytes used for mcache structures obtained from system. Equals to /memory/classes/metadata/mcache/inuse:bytes + /memory/classes/metadata/mcache/free:bytes.
# TYPE go_memstats_mcache_sys_bytes gauge
go_memstats_mcache_sys_bytes 141336
# HELP go_memstats_mspan_inuse_bytes Number of bytes in use by mspan structures. Equals to /memory/classes/metadata/mspan/inuse:bytes.
# TYPE go_memstats_mspan_inuse_bytes gauge
go_memstats_mspan_inuse_bytes 520320
# HELP go_memstats_mspan_sys_bytes Number of bytes used for mspan structures obtained from system. Equals to /memory/classes/metadata/mspan/inuse:bytes + /memory/classes/metadata/mspan/free:bytes.
# TYPE go_memstats_mspan_sys_bytes gauge
go_memstats_mspan_sys_bytes 538560
# HELP go_memstats_next_gc_bytes Number of heap bytes when next garbage collection will take place. Equals to /gc/heap/goal:bytes.
# TYPE go_memstats_next_gc_bytes gauge
go_memstats_next_gc_bytes 1.9641626e+07
# HELP go_memstats_other_sys_bytes Number of bytes used for other system allocations. Equals to /memory/classes/other:bytes.
# TYPE go_memstats_other_sys_bytes gauge
go_memstats_other_sys_bytes 6.137242e+06
# HELP go_memstats_stack_inuse_bytes Number of bytes obtained from system for stack allocator in non-CGO environments. Equals to /memory/classes/heap/stacks:bytes.
# TYPE go_memstats_stack_inuse_bytes gauge
go_memstats_stack_inuse_bytes 3.309568e+06
# HELP go_memstats_stack_sys_bytes Number of bytes obtained from system for stack allocator. Equals to /memory/classes/heap/stacks:bytes + /memory/classes/os-stacks:bytes.
# TYPE go_memstats_stack_sys_bytes gauge
go_memstats_stack_sys_bytes 3.309568e+06
# HELP go_memstats_sys_bytes Number of bytes obtained from system. Equals to /memory/classes/total:byte.
# TYPE go_memstats_sys_bytes gauge
go_memstats_sys_bytes 4.373608e+07
# HELP go_sched_gomaxprocs_threads The current runtime.GOMAXPROCS setting, or the number of operating system threads that can execute user-level Go code simultaneously. Sourced from /sched/gomaxprocs:threads.
# TYPE go_sched_gomaxprocs_threads gauge
go_sched_gomaxprocs_threads 112
# HELP go_threads Number of OS threads created.
# TYPE go_threads gauge
go_threads 45
# HELP multus_server_request_total Counter of HTTP requests
# TYPE multus_server_request_total counter
multus_server_request_total{code="200",handler="/cni",method="post"} 16
multus_server_request_total{code="200",handler="/healthz",method="post"} 21
multus_server_request_total{code="400",handler="/cni",method="post"} 4
# HELP process_cpu_seconds_total Total user and system CPU time spent in seconds.
# TYPE process_cpu_seconds_total counter
process_cpu_seconds_total 1.45
# HELP process_max_fds Maximum number of open file descriptors.
# TYPE process_max_fds gauge
process_max_fds 1.048576e+06
# HELP process_network_receive_bytes_total Number of bytes received by the process over the network.
# TYPE process_network_receive_bytes_total counter
process_network_receive_bytes_total 8.20985728016e+11
# HELP process_network_transmit_bytes_total Number of bytes sent by the process over the network.
# TYPE process_network_transmit_bytes_total counter
process_network_transmit_bytes_total 3.08563312954e+11
# HELP process_open_fds Number of open file descriptors.
# TYPE process_open_fds gauge
process_open_fds 12
# HELP process_resident_memory_bytes Resident memory size in bytes.
# TYPE process_resident_memory_bytes gauge
process_resident_memory_bytes 5.7204736e+07
# HELP process_start_time_seconds Start time of the process since unix epoch in seconds.
# TYPE process_start_time_seconds gauge
process_start_time_seconds 1.76781688317e+09
# HELP process_virtual_memory_bytes Virtual memory size in bytes.
# TYPE process_virtual_memory_bytes gauge
process_virtual_memory_bytes 1.315229696e+09
# HELP process_virtual_memory_max_bytes Maximum amount of virtual memory available in bytes.
# TYPE process_virtual_memory_max_bytes gauge
process_virtual_memory_max_bytes 1.8446744073709552e+19
# HELP promhttp_metric_handler_requests_in_flight Current number of scrapes being served.
# TYPE promhttp_metric_handler_requests_in_flight gauge
promhttp_metric_handler_requests_in_flight 1
# HELP promhttp_metric_handler_requests_total Total number of scrapes by HTTP status code.
# TYPE promhttp_metric_handler_requests_total counter
promhttp_metric_handler_requests_total{code="200"} 72
promhttp_metric_handler_requests_total{code="500"} 0
promhttp_metric_handler_requests_total{code="503"} 0
```


## Developer Notes

### Thick Plugin vs Thin Plugin

**Multus 4.0 introduced a new deployment model:** the thick plugin is now the recommended approach over the traditional thin plugin deployment.

| Feature              | Thick Plugin                                | Thin Plugin                              |
|----------------------|---------------------------------------------|------------------------------------------|
| **Deployment Model** | Client/server (multus-daemon + multus-shim) | Single binary                            |
| **Metrics Support**  | ‚úì Supported                                 | ‚úó Not available                          |
| **Features**         | Additional features via daemon              | Basic functionality only                 |
| **Resource Usage**   | Higher                                      | Lower                                    |
| **Recommendation**   | ‚úì Recommended for most environments         | Legacy/resource-constrained environments |


For detailed comparison, see the [Multus CNI documentation](https://github.com/k8snetworkplumbingwg/multus-cni?tab=readme-ov-file#thin-plugin-vs-thick-plugin).
